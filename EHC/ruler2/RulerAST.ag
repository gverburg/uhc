-- $Id: Ruler.ag 231 2005-06-07 14:39:41Z atze $

-------------------------------------------------------------------------
-- AST
-------------------------------------------------------------------------

-------------------------------------------------------------------------
-- Interfacing
-------------------------------------------------------------------------

DATA AGItf
  | AGItf               decls       : Decls

DATA AGExprItf
  | AGItf               expr        : Expr

DATA AGViewSelsItf
  | AGItf               viewSels    : ViewSels

DATA AGRlSelItf
  | AGItf               rlSel       : RlSel

DATA AGARuleItf
  | AGItf               rule        : ARule

-------------------------------------------------------------------------
-- Declarations
-------------------------------------------------------------------------

DATA Decl
  | Preamble            fmKind      : {FmKind}
                        preamble    : {String}
  | Extern              nms         : {[Nm]}
  | Scheme              scKind      : {ScKind}
                        nm          : {Nm}
                        mbAGNm      : {Maybe String}
                        decls       : Decls
  | SchemeDeriv         scKind      : {ScKind}
                        nm          : {Nm}
                        scDeriv     : {ScDeriv}
                        mbAGNm      : {Maybe String}
                        decls       : Decls
  | Fmt                 fmKind      : {FmKind}
                        atIO        : {AtDir}
                        matchExpr   : Expr
                        expr        : Expr
  | Rules               nm          : {Nm}
                        schemeNm    : {Nm}
                        viewSel     : ViewSel
                        info        : {String}
                        decls       : Decls
  | RulesGroup          nm          : {Nm}
                        schemeNm    : {Nm}
                        viewSel     : ViewSel
                        info        : {String}
                        rlNms       : {[(Nm,Nm)]}
  | Rule                pos         : {SPos}
                        nm          : {Nm}
                        mbBasedOnNm : {Maybe Nm}
                        viewSel     : ViewSel
                        mbAGNm      : {Maybe String}
                        decls       : Decls
  | RulView             nm          : {Nm}
                        pre         : RExprs
                        post        : RExprs
  | ShpJudge            pos         : {SPos}
                        fmKind      : {FmKind}
                        expr        : Expr
  | ShpDel              pos         : {SPos}
                        fmKinds     : {[FmKind]}
  | ScmView             nm          : {Nm}
                        decls       : Decls
  | ViewHierarchy       nmOrder     : {[[Nm]]}
  | Attr                inhs        : AttrIntros
                        inhsyns     : AttrIntros
                        syns        : AttrIntros

TYPE Decls = [Decl]

SET AllDecl = Decl Decls

-------------------------------------------------------------------------
-- Rule selection
-------------------------------------------------------------------------

DATA RlSel
  | Sel                 vwSel       : ViewSels
                        rsSel       : NmSel
                        rlSel       : NmSel

SET AllRlSel = RlSel

-------------------------------------------------------------------------
-- Nm selection
-------------------------------------------------------------------------

DATA NmSel
  | All
  | Nms                 nms         : {[Nm]}

SET AllNmSel = NmSel

-------------------------------------------------------------------------
-- View selection
-------------------------------------------------------------------------

DATA ViewSel
  | All
  | View                nm          : {Nm}
  | Renamed             nmNew       : {Nm}
                        nm          : {Nm}
  | Range               vwFr        : ViewSel
                        vwTo        : ViewSel

TYPE ViewSels = [ViewSel]

SET AllViewSel = ViewSel ViewSels

-------------------------------------------------------------------------
-- Attr defs
-------------------------------------------------------------------------

DATA AttrIntro
  | Intro               props       : {[AtProp]}
                        nm          : {Nm}
                        ty          : {Nm}

TYPE AttrIntros = [AttrIntro]

SET AllAttrIntro = AttrIntro AttrIntros

-------------------------------------------------------------------------
-- Rule expr's
-------------------------------------------------------------------------

DATA RExpr
  | Judge               pos         : {SPos}
                        mbRNm       : {Maybe Nm}
                        schemeNm    : {Nm}
                        eqns        : RExprEqn
  | Del                 pos         : {SPos}
                        nms         : {[Nm]}

DATA RExprEqn
  | Attrs               eqns        : AttrEqns
  | Expr                expr        : Expr

TYPE RExprs = [RExpr]

SET AllRExpr = RExpr RExprs

DATA AttrEqn
  | Eqn                 nm          : {Nm}
                        expr        : Expr
  | Del                 nm          : {Nm}

TYPE AttrEqns = [AttrEqn]

SET AllAttrEqn = RExprEqn AttrEqn AttrEqns

-------------------------------------------------------------------------
-- Expr
-------------------------------------------------------------------------

DATA Expr
  | AppTop              expr        : Expr
  | App                 lExpr       : Expr
                        rExpr       : Expr
  | Op                  nm          : {Nm}
                        nmExpr      : Expr
                        lExpr       : Expr
                        rExpr       : Expr
  | LF                  lExpr       : Expr
                        rExpr       : Expr
  | Var                 nm          : {Nm}
  | AVar                anm         : ANm
  | Int                 int         : {String}
  | StrText             str         : {String}
  | StrAsIs             str         : {String}
  | Named               nm          : {Nm}
                        expr        : Expr
  | Wrap                wrKind      : {WrKind}
                        expr        : Expr
  | Cnstr               expr        : Expr
                        cnstr       : ECnstr
  | WrapCnstr           cnstr       : ECnstr
  | Paren               expr        : Expr
  | Retain              expr        : Expr
  | SelTop              expr        : Expr
  | Sel                 expr        : Expr
                        selMbExpr   : MbExpr
  | ChildOrder          seqNr       : {Int}
                        expr        : Expr
  | Uniq
  | Empty

DATA ANm
  | Wild
  | Loc                 nm          : {Nm}
                        props       : {[AtProp]}
  | Lhs                 nm          : {Nm}
                        props       : {[AtProp]}
  | Fld                 nm          : {Nm}
  | Node                ndNm        : {Nm}
                        nm          : {Nm}

TYPE MbExpr = MAYBE Expr

SET AllExpr = Expr MbExpr ECnstr

DERIVING AllExpr ANm: Eq,Ord

-------------------------------------------------------------------------
-- Expr constraint
-------------------------------------------------------------------------

DATA ECnstr
  | Ty                  nms         : {[Nm]}
  | Var                 nm          : {Nm}
  | Empty

-------------------------------------------------------------------------
-- Rule in AG form
-------------------------------------------------------------------------

DATA ARule
  | Rule                ndNmL       : {[Nm]}
                        rlNm        : {Nm}
                        info        : {[String]}
                        eqns        : AEqns

DATA AEqn
  | Eqn                 dest        : AEqnDest
                        val         : AExpr
  | Err                 expr        : Expr

DATA AExpr
  | Expr                expr        : Expr

DATA AEqnDest
  | One                 anm         : ANm
  | Many                dests       : AEqnDests

TYPE AEqns = [AEqn]

TYPE AEqnDests = [AEqnDest]

SET AllARuleButARule = AEqn AEqns AExpr AEqnDest AEqnDests ANm

SET AllARule = ARule AllARuleButARule

-------------------------------------------------------------------------
-- Sets of AST data's
-------------------------------------------------------------------------

SET AllNTButViewSel = AllRExpr AllExpr AllAttrEqn AllAttrIntro AllDecl AllARule

SET AllNT = AllNTButViewSel AllViewSel

