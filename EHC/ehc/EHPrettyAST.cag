% $Id: EHPrettyAST.cag 269 2005-08-14 12:49:00Z cddouma $

%%[0
%include lhs2TeX.fmt
%include afp.fmt
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Pretty printing of internal AST structure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[1 hs
ppNest :: PP a => [a] -> PP_DocL -> PP_DocL -> PP_Doc
ppNest nms attrs ps = ppNestInfo defaultEHCOpts nms attrs ps []

ppNestInfo :: PP a => EHCOpts -> [a] -> PP_DocL -> PP_DocL -> AssocL String PP_Doc -> PP_Doc
ppNestInfo opts nms attrs ps infos
  = ppListSep "" "" "_" nms
    >#< (   (if null attrs then empty else ppSpaced attrs)
        >-< (if ehcoptDebug opts then vlist (map (\(i,p) -> pp i >|< ":" >#< p) infos) else empty)
        )
    >-< indent 2 (vlist ps)

ppNm :: HsName -> PP_Doc
ppNm = text . show . show

mkInfo1 :: String -> PP_Doc -> (String,PP_Doc)
mkInfo1 = (,)
%%]

%%[1
ATTR AllNT AGItf [ | | ppAST USE {>-<} {empty} : PP_Doc ]

SEM AGItf
  | AGItf       lhs     .  ppAST    =   ppNestInfo @lhs.opts ["AGItf","AGItf"] [] [@expr.ppAST] (@info ++ @info_2 ++ @info_3 ++ @info_4_2 ++ @info_8)
                loc     .  info     =   []
                        .  info_2   =   []
                        .  info_3   =   []
                        .  info_4_2 =   []
                        .  info_8   =   []

SEM Decl
  | Val         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Decl","Val"] [] [@patExpr.ppAST,@expr.ppAST] @info
                loc     .  info     =   [ mkInfo1 "lhs.tySigGam" (ppGam @lhs.tySigGam)
                                        ]
  | TySig       lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Decl","TySig"] [ppNm @nm] [@tyExpr.ppAST] @info
                loc     .  info     =   [ mkInfo1 "tyExpr.ty" (ppTy @tyExpr.ty)
                                        ]

SEM Expr
  | IConst      lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","IConst"] [@pp] [] (@info_1 ++ @info_2)
                loc     .  info_1   =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        ]
                        .  info_2   =   []
  | CConst      lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","CConst"] [@pp] [] (@info_1 ++ @info_2)
                loc     .  info_1   =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        ]
                        .  info_2   =   []
  | Var         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","Var"] [ppNm @nm] [] (@info ++ @info_2 ++ @info_4 ++ @info_4_2 ++ @info_9)
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        , mkInfo1 "ty_g_" (ppTy @ty_g_)
                                        , mkInfo1 "ty" (ppTy @ty)
                                        ]
                        .  info_2   =   []
                        .  info_4   =   []
                        .  info_4_2 =   []
                        .  info_9   =   []
  | Con         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","Con"] [ppNm @nm] [] (@info ++ @info_4)
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        , mkInfo1 "ty" (ppTy @ty)
                                        ]
                        .  info_4   =   []
  | Let         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","Let"] [] [@decls.ppAST] (@info_2 ++ @info_3 ++ @info_4_2 ++ @info_6 ++ @info_9)
                                        >-< @body.ppAST
                loc     .  info_2   =   []
                        .  info_3   =   []
                        .  info_4_2 =   []
                        .  info_6   =   []
                        .  info_9   =   []
  | App         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","App"] [] [@func.ppAST,@arg.ppAST] (@info_1 ++ @info_2 ++ @info_4_2 ++ @info_9)
                loc     .  info_1   =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        ]
                        .  info_2   =   []
                        .  info_4_2 =   []
                        .  info_9   =   []
  | Parens      lhs     .  ppAST    =   ppNest ["Expr","Parens"] [] [@expr.ppAST]
  | AppTop      lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","AppTop"] [] [@expr.ppAST] (@info ++ @info_2 ++ @info_4 ++ @info_9)
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        , mkInfo1 "expr.ty" (ppTy @expr.ty)
                                        ]
                        .  info_2   =   []
                        .  info_4   =   []
                        .  info_9   =   []
  | Lam         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","Lam"] [] [@arg.ppAST,@body.ppAST] (@info ++ @info_2 ++ @info_9 ++ @info_4_2)
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        , mkInfo1 "arg.valGam" (ppGam @arg.valGam)
                                        ]
                        .  info_2   =   []
                        .  info_9   =   []
                        .  info_4_2 =   []
  | TypeAs      lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","TypeAs"] [] [@expr.ppAST,@tyExpr.ppAST] @info_3
                loc     .  info_3   =   []

SEM PatExpr
  | IConst      lhs     .  ppAST    =   ppNest ["PatExpr","IConst"] [@pp] []
  | CConst      lhs     .  ppAST    =   ppNest ["PatExpr","CConst"] [@pp] []
  | Var         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["PatExpr","Var"] [ppNm @nm] [] (@info_1 ++ @info_2)
                loc     .  info_1   =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        ]
                        .  info_2   =   []
  | VarAs       lhs     .  ppAST    =   ppNest ["PatExpr","VarAs"] [ppNm @nm] [@patExpr.ppAST]
  | Con         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["PatExpr","Con"] [ppNm @nm] [] (@info ++ @info_2 ++ @info_4)
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        ]
                        .  info_2   =   []
                        .  info_4   =   []
  | App         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["PatExpr","App"] [] [@func.ppAST,@arg.ppAST] @info
                loc     .  info     =   []
  | Parens      lhs     .  ppAST    =   ppNest ["PatExpr","Parens"] [] [@patExpr.ppAST]
  | AppTop      lhs     .  ppAST    =   ppNestInfo @lhs.opts ["PatExpr","AppTop"] [] [@patExpr.ppAST] (@info ++ @info_2)
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        ]
                        .  info_2   =   []
  
SEM TyExpr
  | Con         lhs     .  ppAST    =   ppNest ["TyExpr","Con"] [ppNm @nm] []
  | App         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["TyExpr","App"] [] [@func.ppAST,@arg.ppAST] @info
                loc     .  info     =   []
  | Parens      lhs     .  ppAST    =   ppNest ["TyExpr","Parens"] [] [@tyExpr.ppAST]
  | AppTop      lhs     .  ppAST    =   ppNestInfo @lhs.opts ["TyExpr","AppTop"] [] [@tyExpr.ppAST] @info
                loc     .  info     =   [ mkInfo1 "appFunNm" (ppNm @tyExpr.appFunNm)
                                        ]

SEM Decls
  | Nil         lhs     .  ppAST    =   ppNest ["Decls","Nil"] [] []
  | Cons        lhs     .  ppAST    =   ppNest ["Decls","Cons"] [] [@hd.ppAST,@tl.ppAST]
%%]

%%[2
SEM Decl
  | Val         loc     .  info     :=  [ mkInfo1 "lhs.tySigGam" (ppGam @lhs.tySigGam)
                                        , mkInfo1 "ty_sig_" (ppTy @ty_sig_)
                                        , mkInfo1 "patExpr.ty" (ppTy @patExpr.ty)
                                        , mkInfo1 "expr.ty" (ppTy @expr.ty)
                                        , mkInfo1 "lhs.tyCnstr" (ppCnstrV @lhs.tyCnstr)
                                        , mkInfo1 "expr.tyCnstr" (ppCnstrV @expr.tyCnstr)
                                        ]

SEM Expr
  | IConst CConst
                loc     .  info_2   :=  [ mkInfo1 "knTy+lhs.cnstr" (ppTy (@lhs.tyCnstr |=> @lhs.knTy))
                                        , mkInfo1 "foCnstr fo" (pp (foCnstr @fo_))
                                        ]
  | Var         loc     .  info_2   :=  [ mkInfo1 "lhs.cnstr" (ppCnstrV @lhs.tyCnstr)
                                        , mkInfo1 "knTy+lhs.cnstr" (ppTy (@lhs.tyCnstr |=> @lhs.knTy))
                                        , mkInfo1 "foCnstr fo" (pp (foCnstr @fo_))
                                        ]
  | App         loc     .  info_2   :=  [ mkInfo1 "knTy+lhs.cnstr" (ppTy (@lhs.tyCnstr |=> @lhs.knTy))
                                        , mkInfo1 "func.ty" (ppTy @func.ty)
                                        , mkInfo1 "ty" (ppTy @ty)
                                        ]
  | AppTop      loc     .  info_2   :=  [ mkInfo1 "lhs.tyCnstr" (ppCnstrV @lhs.tyCnstr)
                                        , mkInfo1 "expr.tyCnstr" (ppCnstrV @expr.tyCnstr)
                                        ]
  | Lam         loc     .  info_2   :=  [ mkInfo1 "knTy+lhs.tyCnstr" (ppTy (@lhs.tyCnstr |=> @lhs.knTy))
                                        , mkInfo1 "foTy @fo_fitF_" (ppTy (foTy @fo_fitF_))
                                        , mkInfo1 "foCnstr @fo_fitF_" (pp (foCnstr @fo_fitF_))
                                        , mkInfo1 "ty" (ppTy @ty)
                                        , mkInfo1 "body.tyCnstr" (pp @body.tyCnstr)
                                        , mkInfo1 "lhs.finTyCnstr" (pp @lhs.finTyCnstr)
                                        ]
  | Let         loc     .  info_2   :=  [ mkInfo1 "decls.gathTySigGam" (pp @decls.gathTySigGam)
                                        , mkInfo1 "valGam_l_" (pp (gamTop @decls.patValGam))
                                        , mkInfo1 "valGam_l_+decls.tyCnstr" (pp (@decls.tyCnstr |=> gamTop @decls.patValGam))
                                        ]

SEM PatExpr
  | Var         loc     .  info_2   :=  [ mkInfo1 "ty" (ppTy @ty)
                                        ]
  | AppTop      loc     .  info_2   :=  [ mkInfo1 "patExpr.patFunTy" (ppTy @patExpr.patFunTy)
                                        , mkInfo1 "patExpr.ty" (ppTy @patExpr.ty)
                                        , mkInfo1 "ty" (ppTy @ty)
                                        , mkInfo1 "lhs.tyCnstr" (pp @lhs.tyCnstr)
                                        , mkInfo1 "patExpr.tyCnstr" (pp @patExpr.tyCnstr)
                                        ]
  | Con         loc     .  info_2   :=  [ mkInfo1 "ty" (ppTy @ty)
                                        ]
%%]
                                        -- , mkInfo1 "decls.tyCnstr" (ppCnstrV @decls.tyCnstr)

%%[3
SEM TyExpr
  | Var         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["TyExpr","Var"] [ppNm @nm] [] @info
                loc     .  info     =   []

SEM Expr
  | Let         loc     .  info_3   :=  [ mkInfo1 "lSubsValGam_" (ppGam @lSubsValGam_)
                                        ]
  | TypeAs      loc     .  info_3   :=  [ mkInfo1 "ty_q_" (ppTy @ty_q_)
                                        ]

%%]

%%[4
SEM Expr
  | Var         loc     .  info_4   :=  [ mkInfo1 "lhs.fiOpts" (pp @lhs.fiOpts)
                                        ]
  | AppTop      loc     .  info_4   :=  [ mkInfo1 "lhs.fiOpts" (pp @lhs.fiOpts)
                                        ]
  | Con         loc     .  info_4   :=  [ mkInfo1 "foCnstr" (pp (foCnstr @fo_))
                                        ]
  | AppImpred   lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","AppImpred"] [] [@func.ppAST,@arg.ppAST] @info_4
                loc     .  info_4   =   [ 
                                        ]

SEM PatExpr
  | TypeAs      lhs     .  ppAST    =   ppNestInfo @lhs.opts ["PatExpr","TypeAs"] [] [@patExpr.ppAST,@tyExpr.ppAST] @info
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        , mkInfo1 "tyExpr.ty" (ppTy @tyExpr.ty)
                                        , mkInfo1 "patExpr.ty" (ppTy @patExpr.ty)
                                        , mkInfo1 "foCnstr fo" (pp (foCnstr @fo_))
                                        ]
  | Con         loc     .  info_4   :=  [ mkInfo1 "ty_r_" (ppTy @ty_r_)
                                        ]

SEM TyExpr
  | Quant       lhs     .  ppAST    =   ppNest ["TyExpr","Quant"] [text (showTyQu @qu),ppNm @tyVar] [@tyExpr.ppAST]
%%]

%%[4_2
SEM AGItf
  | AGItf       loc     .  info_4_2 :=  [ mkInfo1 "expr.imprTyCnstr" (ppCnstrV @expr.imprTyCnstr)
                                        ]

SEM Expr
  | Var         loc     .  info_4_2 :=  [ mkInfo1 "imprTy" (ppTy @imprTy)
                                        , mkInfo1 "lhs.imprTyCnstr" (ppCnstrV @lhs.imprTyCnstr)
                                        ]
  | Let         loc     .  info_4_2 :=  [ mkInfo1 "decls.imprTyCnstr" (ppCnstrV @decls.imprTyCnstr)
                                        , mkInfo1 "lhs.tyCnstr" (ppCnstrV @lhs.tyCnstr)
                                        , mkInfo1 "decls.patTyCnstr" (ppCnstrV @decls.patTyCnstr)
                                        , mkInfo1 "decls.tyCnstr" (ppCnstrV @decls.tyCnstr)
                                        , mkInfo1 "body.imprTyCnstr" (ppCnstrV @body.imprTyCnstr)
                                        , mkInfo1 "imprTyCnstr_elim_" (ppCnstrV @imprTyCnstr_elim_)
                                        , mkInfo1 "quValGam_ex_" (ppGam (@quValGam_ex_))
                                        ]
  | App         loc     .  info_4_2 :=  [ mkInfo1 "arg.imprTy" (ppTy @arg.imprTy)
                                        , mkInfo1 "func.imprTy" (ppTy @func.imprTy)
                                        , mkInfo1 "foTy fo_fitA_ (arg)" (ppTy (foTy @fo_fitA_))
                                        , mkInfo1 "foTy fo_fitF_ (fun)" (ppTy (foTy @fo_fitF_))
                                        , mkInfo1 "imprTy" (ppTy @imprTy)
                                        ]
  | Lam         loc     .  info_4_2 :=  [ mkInfo1 "valGam_l_" (ppGam @valGam_l_)
                                        , mkInfo1 "lArgElimValGam" (ppGam @lArgElimValGam)
                                        , mkInfo1 "knTy+lhs.imprTyCnstr" (ppTy (@lhs.imprTyCnstr |=> @lhs.knTy))
                                        , mkInfo1 "lhs.imprTyCnstr" (ppCnstrV @lhs.imprTyCnstr)
                                        , mkInfo1 "arg.tyCnstr" (ppCnstrV @arg.tyCnstr)
                                        , mkInfo1 "body.imprTyCnstr" (ppCnstrV @body.imprTyCnstr)
                                        , mkInfo1 "foTy @fo_ifitF_" (ppTy (foTy @fo_ifitF_))
                                        , mkInfo1 "foCnstr @fo_ifitF_" (pp (foCnstr @fo_ifitF_))
                                        , mkInfo1 "imprTyCnstr_elim_" (ppCnstrV @imprTyCnstr_elim_)
                                        , mkInfo1 "lhs.tyCnstr" (ppCnstrV @lhs.tyCnstr)
                                        , mkInfo1 "lhs.fiOpts" (pp @lhs.fiOpts)
                                        ]
%%]

%%[5
SEM Decl
  | Data        lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Decl","Data"] [ppNm @tyNm] [@tyVars.ppAST,@constrs.ppAST] @info_6
                loc     .  info_6   =   []

SEM Expr
  | Case        lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","Case"] [] [@expr.ppAST,@alts.ppAST] @info
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy (@lhs.tyCnstr |=> @lhs.knTy))
                                        ]

SEM CaseAlt
  | Pat         lhs     .  ppAST    =   ppNest ["CaseAlt","Pat"] [] [@patExpr.ppAST,@expr.ppAST]

SEM CaseAlts
  | Nil         lhs     .  ppAST    =   ppNestInfo @lhs.opts  ["CaseAlts","Nil"] [] [] @info
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy (@lhs.tyCnstr |=> @lhs.knTy))
                                        ]
  | Cons        lhs     .  ppAST    =   ppNestInfo @lhs.opts ["CaseAlts","Cons"] [] [@hd.ppAST,@tl.ppAST] @info
                loc     .  info     =   [ mkInfo1 "knTy" (ppTy (@lhs.tyCnstr |=> @lhs.knTy))
                                        ]

SEM TyExprs
  | Nil         lhs     .  ppAST    =   ppNest ["TyExprs","Nil"] [] []
  | Cons        lhs     .  ppAST    =   ppNest ["TyExprs","Cons"] [] [@hd.ppAST,@tl.ppAST]

SEM TyVar
  | Var         lhs     .  ppAST    =   ppNestInfo @lhs.opts ["TyVar","Var"] [ppNm @nm] [] @info_6
                loc     .  info_6   =   []

SEM TyVars
  | Nil         lhs     .  ppAST    =   ppNest ["TyVars","Nil"] [] []
  | Cons        lhs     .  ppAST    =   ppNest ["TyVars","Cons"] [] [@hd.ppAST,@tl.ppAST]

SEM DataConstr
  | Constr      loc     .  ppAST    =   ppNestInfo @lhs.opts ["DataConstr","Constr"] [ppNm @conNm] [@fields.ppAST] @info_6
                loc     .  info_6   =   []

SEM DataConstrs
  | Nil         lhs     .  ppAST    =   ppNest ["DataConstrs","Nil"] [] []
  | Cons        lhs     .  ppAST    =   ppNest ["DataConstrs","Cons"] [] [@hd.ppAST,@tl.ppAST]
%%]

%%[6
SEM TyVar
  | Var         loc     .  info_6   :=  [ mkInfo1 "tgi_" (pp @tgi_)
                                        ]
SEM TyExpr
  | Var         loc     .  info     :=  [ mkInfo1 "tgi_" (pp @tgi_)
                                        ]
SEM Decl
  | Data        loc     .  info_6   :=  [ mkInfo1 "dataKi" (ppTy @dataKi)
                                        , mkInfo1 "lhs.tyGam" (ppGam @lhs.tyGam)
                                        ]

SEM DataConstr
  | Constr      loc     .  info_6   :=  [ mkInfo1 "fields.kiCnstr" (pp @fields.kiCnstr)
                                        , mkInfo1 "foCnstr @fo_" (pp (foCnstr @fo_))
                                        ]

SEM Expr
  | Let         loc     .  info_6   :=  [ mkInfo1 "tyGam_l_" (ppGam @tyGam_l_)
                                        , mkInfo1 "decls.kiCnstr" (pp @decls.kiCnstr)
                                        ]
%%]

%%[7
SEM Expr
  | Rec         loc     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","Rec"] [] [@recExpr.ppAST] @info
                        .  info     =   [ mkInfo1 "lhs.knTy" (pp @lhs.knTy)
                                        , mkInfo1 "lhs.knTy+subst" (pp (@recExpr.tyCnstr |=> @lhs.knTy))
                                        , mkInfo1 "recExpr.ty" (pp @recExpr.ty)
                                        , mkInfo1 "ty" (pp @ty)
                                        ]
  | Sel         loc     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","Sel"] [ppNm @lbl] [@expr.ppAST] @info
                        .  info     =   [ mkInfo1 "lhs.knTy" (pp @lhs.knTy)
                                        ]

SEM PatExpr
  | Rec         loc     .  ppAST    =   ppNest ["PatExpr","Rec"] [] [@recPatExpr.ppAST]

SEM TyExpr
  | Row         loc     .  ppAST    =   ppNest ["TyExpr","Row"] [] [@rowTyExpr.ppAST]

SEM RecExpr
  | Empty       loc     .  ppAST    =   ppNestInfo @lhs.opts ["RecExpr","Empty"] [] [] @info
                        .  info     =   [ mkInfo1 "lhs.knTy" (pp @lhs.knTy)
                                        , mkInfo1 "ty" (pp @ty)
                                        ]
  | Ext         loc     .  ppAST    =   ppNestInfo @lhs.opts ["RecExpr","Ext"] [ppNm @nm] [@recExpr.ppAST,@expr.ppAST] @info
                        .  info     =   [ mkInfo1 "lhs.knTy" (pp @lhs.knTy)
                                        , mkInfo1 "foTy foKnRec" (pp (foTy @foKnRec))
                                        , mkInfo1 "recTy" (pp @recTy)
                                        , mkInfo1 "ty" (pp @ty)
                                        ]
  | Upd         loc     .  ppAST    =   ppNestInfo @lhs.opts ["RecExpr","Upd"] [ppNm @nm] [@recExpr.ppAST,@expr.ppAST] @info
                        .  info     =   [ mkInfo1 "lhs.knTy" (pp @lhs.knTy)
                                        , mkInfo1 "foTy foKnRec" (pp (foTy @foKnRec))
                                        , mkInfo1 "recTy" (pp @recTy)
                                        , mkInfo1 "ty" (pp @ty)
                                        , mkInfo1 "finRecTy" (pp (@lhs.finTyCnstr |=> @recExpr.ty))
                                        ]
  | Expr        loc     .  ppAST    =   ppNestInfo @lhs.opts ["RecExpr","Expr"] [] [@expr.ppAST] @info
                        .  info     =   [ mkInfo1 "expr.ty" (pp @expr.ty)
                                        ]

SEM RecPatExpr
  | Empty       loc     .  ppAST    =   ppNest ["RecPatExpr","Empty"] [] []
  | Ext         loc     .  ppAST    =   ppNest ["RecPatExpr","Ext"] [ppNm @nm] [@recPatExpr.ppAST,@patExpr.ppAST]
  | Expr        loc     .  ppAST    =   ppNestInfo @lhs.opts ["RecPatExpr","Expr"] [] [@patExpr.ppAST] @info
                        .  info     =   []

SEM RowTyExpr
  | Empty       loc     .  ppAST    =   ppNest ["RowTyExpr","Empty"] [] []
  | Ext         loc     .  ppAST    =   ppNest ["RowTyExpr","Ext"] [ppNm @nm] [@rowTyExpr.ppAST,@tyExpr.ppAST]

SEM DataField
  | Field       loc     .  ppAST    =   ppNest ["DataField","Field"] [pp (maybe [] (map ppNm) @mbLabels)] [@tyExpr.ppAST]

SEM DataFields
  | Nil         lhs     .  ppAST    =   ppNest ["DataFields","Nil"] [] []
  | Cons        lhs     .  ppAST    =   ppNest ["DataFields","Cons"] [] [@hd.ppAST,@tl.ppAST]
%%]

%%[8
SEM Decl
  | FFI         loc     .  ppAST    =   ppNestInfo @lhs.opts ["Decl","FFI"] [pp (show @impEnt),ppNm @nm] [@tyExpr.ppAST] @info
                        .  info     =   []

SEM AGItf
  | AGItf       loc     .  info_8   :=  [ mkInfo1 "expr.cexpr" (pp @expr.cexpr)
                                        ]
%%]

%%[9
SEM RowTyExpr
  | Var         loc     .  ppAST    =   ppNest ["RowTyExpr","Var"] [ppNm @nm] []

SEM TyExpr
  | Pred        loc     .  ppAST    =   ppNest ["TyExpr","Pred"] [] [@prExpr.ppAST]

SEM PrExpr
  | Class       loc     .  ppAST    =   ppNest ["PrExpr","Class"] [ppNm @nm] [@tyExprs.ppAST]
  | Arrow       loc     .  ppAST    =   ppNest ["PrExpr","Arrow"] [] [@arg.ppAST,@res.ppAST]

SEM Decl
  | Class       loc     .  ppAST    =   ppNestInfo @lhs.opts ["Decl","Class"] [] [@tyPrExpr.ppAST,@funcDeps.ppAST,@decls.ppAST] @info
                        .  info     =   []
  | Instance    loc     .  ppAST    =   ppNestInfo @lhs.opts ["Decl","Instance"] (maybe [] (\(n,_) -> [ppNm n]) @mbNmElim) [@tyPrExpr.ppAST,@decls.ppAST] @info
                        .  info     =   [ mkInfo1 "prfCtxtId's" (pp @lhs.prfCtxtId >#< "-" >#< pp @prfCtxtId)
                                        , mkInfo1 "prTyFix" (ppTy @prTyFix)
                                        , mkInfo1 "tyPrExpr.evTy" (ppTy @tyPrExpr.evTy)
                                        , mkInfo1 "recTy" (ppTy @recTy)
                                        , mkInfo1 "decls.prElimTGam" (pp @decls.prElimTGam)
                                        , mkInfo1 "gathDeclSubsPredL" (ppCommaList @gathDeclSubsPredL)
                                        , mkInfo1 "dbg2PrfG (decl)" (pp @dbg2PrfG)
                                        , mkInfo1 "dbg2PrfPruneG (decl)" (pp @dbg2PrfPruneG)
                                        , mkInfo1 "dbg2PrfOrG (decl)" (pp @dbg2PrfOrG)
                                        , mkInfo1 "dbg2PrfIntermG1 (decl)" (pp @dbg2PrfIntermG1)
                                        , mkInfo1 "dbg2PrfIntermG2 (decl)" (pp @dbg2PrfIntermG2)
                                        , mkInfo1 "dbg2PrLeaves (decl)" (ppCommaList @dbg2PrLeaves)
                                        , mkInfo1 "dbg2PrElimTGam" (pp @dbg2PrElimTGam)
                                        , mkInfo1 "dbg2TrPPL (decl)" (vlist @dbg2TrPPL)
                                        , mkInfo1 "prfFrPoiCxBindLM" (ppCxBindLMap @prfFrPoiCxBindLM)
                                        , mkInfo1 "prfCSubst" (ppAssocLV . Map.toList $ @prfCSubst)
                                        ]
  | InstanceIntro
                loc     .  ppAST    =   ppNestInfo @lhs.opts ["Decl","InstanceIntro"] [] [@expr.ppAST,@prExpr.ppAST] @info
                        .  info     =   []

SEM FuncDep
  | Dep         loc     .  ppAST    =   ppNest ["FuncDep","Dep"] [] [@fromTvs.ppAST,@toTvs.ppAST]

SEM FuncDeps
  | Nil         lhs     .  ppAST    =   ppNest ["FuncDeps","Nil"] [] []
  | Cons        lhs     .  ppAST    =   ppNest ["FuncDeps","Cons"] [] [@hd.ppAST,@tl.ppAST]
%%]

%%[9
SEM Expr
  | Var         loc     .  info_9   :=  [ mkInfo1 "foLCoeL @fo_" (ppCommaList (foLCoeL @fo_))
                                        , mkInfo1 "foRCoeL @fo_" (ppCommaList (foRCoeL @fo_))
                                        ]
  | Let         loc     .  info_9   :=  [ mkInfo1 "prfCtxtId's" (pp @lhs.prfCtxtId >#< "-" >#< pp @prfCtxtId)
                                        , mkInfo1 "decls.prElimTGam" (pp @decls.prElimTGam)
                                        , mkInfo1 "gathDeclSubsPredL" (ppCommaList @gathDeclSubsPredL)
                                        , mkInfo1 "dbg2PrfG (decl)" (pp @dbg2PrfG)
                                        , mkInfo1 "dbg2PrfPruneG (decl)" (pp @dbg2PrfPruneG)
                                        , mkInfo1 "dbg2PrfOrG (decl)" (pp @dbg2PrfOrG)
                                        , mkInfo1 "dbg2PrfIntermG1 (decl)" (pp @dbg2PrfIntermG1)
                                        , mkInfo1 "dbg2PrfIntermG2 (decl)" (pp @dbg2PrfIntermG2)
                                        , mkInfo1 "dbg2PrLeaves (decl)" (ppCommaList @dbg2PrLeaves)
                                        , mkInfo1 "dbg2PrElimTGam" (pp @dbg2PrElimTGam)
                                        , mkInfo1 "dbg2TrPPL (decl)" (vlist @dbg2TrPPL)
                                        , mkInfo1 "prfFrPoiCxBindLM" (ppCxBindLMap @prfFrPoiCxBindLM)
                                        , mkInfo1 "prfCSubst" (ppAssocLV . Map.toList $ @prfCSubst)
                                        , mkInfo1 "prfPoiFwdMp (decl)" (ppAssocLV . assocLMapElt ppCommaList . Map.toList $ @prfPoiFwdMp)
                                        , mkInfo1 "prfPoiBackMp (decl)" (ppAssocLV . Map.toList $ @prfPoiBackMp)
                                        , mkInfo1 "prfArgPrOccL (decl)" (ppCommaList @prfArgPrOccL)
                                        , mkInfo1 "gathPredL (decl)" (ppCommaList @gathPredL)
                                        , mkInfo1 "tqoGam" (pp @tqoGam)
                                        ]
  | Lam         loc     .  info_9   :=  [ mkInfo1 "prfCtxtId's" (pp @lhs.prfCtxtId >#< "-" >#< pp @prfCtxtId)
                                        , mkInfo1 "imTy" (pp @imTy)
                                        , mkInfo1 "imTy+subst" (pp (@body.tyCnstr |=> @imTy))
                                        , mkInfo1 "knImpls" (pp @knImpls)
                                        , mkInfo1 "knPrL" (ppCommaList @knPrL)
                                        , mkInfo1 "body.prElimTGam" (pp @body.prElimTGam)
                                        , mkInfo1 "lamBodyCoeL" (ppCommaList @lamBodyCoeL)
                                        , mkInfo1 "lamArgCoeL" (ppCommaList @lamArgCoeL)
                                        , mkInfo1 "impls2KnHd" (pp @impls2KnHd)
                                        , mkInfo1 "impls2KnTl" (pp @impls2KnTl)
                                        , mkInfo1 "poiL" (ppCommaList @poiL)
                                        , mkInfo1 "availPoiS" (ppCommaList . Set.toList $ @availPoiS)
                                        ]
  | AppTop      loc     .  info_9   :=  [ mkInfo1 "prfCtxtId's" (pp @lhs.prfCtxtId >#< "-" >#< pp @prfCtxtId)
                                        , mkInfo1 "resTy" (pp @resTy)
                                        , mkInfo1 "foCnstr @foKnRes" (pp (foCnstr @foKnRes))
                                        , mkInfo1 "ty" (pp @ty)
                                        , mkInfo1 "imTy" (pp @imTy)
                                        , mkInfo1 "imTy+subst" (pp (@expr.tyCnstr |=> @imTy))
                                        ]
  | AppImpl     lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","AppImpl"] [] [@func.ppAST,@arg.ppAST,@argPr.ppAST] @info_9
                loc     .  info_9   =   [ mkInfo1 "knTy" (ppTy @lhs.knTy)
                                        ]
  | LamImpl     lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","LamImpl"] [] [@arg.ppAST,@argPr.ppAST,@body.ppAST] @info_9
                loc     .  info_9   =   [ mkInfo1 "prfCtxtId's" (pp @lhs.prfCtxtId >#< "-" >#< pp @prfCtxtId)
                                        , mkInfo1 "lhs.knTy" (pp @lhs.knTy)
                                        , mkInfo1 "funTy" (pp @funTy)
                                        , mkInfo1 "foTy @fo_fitF_" (ppTy (foTy @fo_fitF_))
                                        , mkInfo1 "foTy @foPr" (pp (foTy @foPr))
                                        , mkInfo1 "ty" (pp @ty)
                                        , mkInfo1 "knPrL" (ppCommaList @knPrL)
                                        , mkInfo1 "lamBodyCoeL" (ppCommaList @lamBodyCoeL)
                                        , mkInfo1 "lamArgCoeL" (ppCommaList @lamArgCoeL)
                                        ]
%%]

%%[10
SEM Expr
  | DynVar      lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Expr","DynVar"] [ppNm @nm] [] (@info)
                loc     .  info     =   [
                                        ]

SEM PrExpr
  | Lacks       loc     .  ppAST    =   ppNest ["PrExpr","Lacks"] [ppNm @nm] [@rowTyExpr.ppAST]
  | DynVar      loc     .  ppAST    =   ppNest ["PrExpr","DynVar"] [ppNm @nm] [@tyExpr.ppAST]

SEM Decl
  | DynVal      lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Decl","DynVal"] [ppNm @nm] [@expr.ppAST] @info
                loc     .  info     =   [
                                        ]
  | DynTySig    lhs     .  ppAST    =   ppNestInfo @lhs.opts ["Decl","DynTySig"] [ppNm @nm] [@tyExpr.ppAST] @info
                loc     .  info     =   [
                                        ]
%%]

%%[11
SEM DataConstrEq
  | Eq          lhs     .  ppAST    =   ppNest ["DataConstrEq","Eq"] [] [@tyVar.ppAST,@tyExpr.ppAST]

SEM DataConstrEqs
  | Nil         lhs     .  ppAST    =   ppNest ["DataConstrEqs","Nil"] [] []
  | Cons        lhs     .  ppAST    =   ppNest ["DataConstrEqs","Cons"] [] [@hd.ppAST,@tl.ppAST]

SEM DataConstr
  | Constr      loc     .  ppAST    :=  ppNestInfo @lhs.opts  ["DataConstr","Constr"] [ppNm @conNm] [@fields.ppAST,@eqs.ppAST] @info
                loc     .  info     =   [ mkInfo1 "eqs.eqTyCnstr" (pp @eqs.eqTyCnstr)
                                        ]
%%]


