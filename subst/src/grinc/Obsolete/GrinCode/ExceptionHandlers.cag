%%[0
%include lhs2TeX.fmt
%include afp.fmt
%%]

%%%%%%%%%%%%%%%%%%%%%%%%
%% Exception Handlers %%
%%%%%%%%%%%%%%%%%%%%%%%%

names of labels used for handlers (shared with ToCmm.cag)

%%[8.names
SEM GrExpr
  | Catch  loc  .  argName      =  cmmName' @arg
                .  ehName       =  "@eh"
                .  ehVar        =  cmmVar @ehName
                .  prevName     =  "@prev_eh_" ++ @argName
                .  prevVar      =  cmmVar @prevName
                .  afterLabel   =  "@after_" ++ @argName
                .  handlerName  =  "@handler_" ++ @argName
%%]

%%[8.handler
ATTR AllGrExpr [ | | handlers USE {~>} {emptyBuilder}: CmmBodyBuilder ]
SEM GrExpr
  | Catch  loc  .  handlerCmm   =  @leaveTry ~> @handler.cmmBody ~> cmmGoto (cmmVar @afterLabel)
                .  decl         =  varDecl False "" bits32 [(@argName, Nothing)]
                .  contName     =  lift body (CmmStatement_Continuation @handlerName [("address", @argName)])
                .  leaveTry     =  cmmAssign [varUpdate @ehName] [memRef bits32 @prevVar]
           lhs  .  handlers     = @body.handlers ~> @decl ~> @contName ~> @handlerCmm ~> @handler.handlers
%%]

flow annotations of the continuations the C-- code can cut to (used by cut to and funcion call)

%%[8.handlersInScope
ATTR AllGrExpr [ handlerName: CmmName | | ]
SEM GrBind
  | Bind   expr  .  handlerName  =  ""
SEM GrExpr
  | Catch  body  .  handlerName  =  @handlerName
%%]
