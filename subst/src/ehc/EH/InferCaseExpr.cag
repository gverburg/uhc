%%[0
%include lhs2TeX.fmt
%include afp.fmt
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Type inferencing for Case Expr
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Pattern type of Case Expr
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[5
ATTR AllCase [ knPatTy: Ty | patTyVarMp: VarMp | patTy: Ty ]

SEM Expr
  | Case        alts        .   knPatTy             =   @expr.ty
                            .   patTyVarMp          =   @expr.tyVarMp
                            .   tyVarMp             =   @alts.patTyVarMp

SEM CaseAlt
  | Pat         patExpr     .   tyVarMp             =   @lhs.patTyVarMp
                            .   knTy                =   @lhs.knPatTy
                            .   valGam              =   gamPushNew @lhs.valGam
                lhs         .   patTyVarMp          =   @patExpr.tyVarMp
                            .   patTy               =   @patExpr.ty

SEM CaseAlts
  | Nil         lhs         .   patTy               =   @lhs.knPatTy
  | Cons        tl          .   knPatTy             =   @lhs.knPatTy
%%]
  | Nil         lhs         .   patTy               =   @lhs.patTyVarMp |=> @lhs.knPatTy
  | Cons        tl          .   knPatTy             =   @hd.patTyVarMp |=> @lhs.knPatTy

%%[6
SEM Expr
  | Case        alts        .   patTyVarMp          :=  agFakeDependOn @alts.kiVarMp @expr.tyVarMp
%%]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Type of Case Expr
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%[5
ATTR AllCase [ knTy: Ty | | ty: Ty ]

SEM Expr
  | Case        expr        .   knTy                =   mkTyVar @lUniq2
                alts        .   knTy                =   @lhs.knTy

SEM CaseAlt
  | Pat         expr        .   tyVarMp             =   @lhs.tyVarMp
                lhs         .   ty                  =   @expr.ty
                            .   tyVarMp             =   @expr.tyVarMp

SEM CaseAlts
  | Nil         lhs         .   ty                  =   @lhs.knTy
  | Cons        hd          .   knTy                =   @lhs.knTy
                tl          .   knTy                =   @hd.ty
%%]

